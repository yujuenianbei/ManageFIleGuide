'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.composeWithElastic = composeWithElastic;

var _graphqlCompose = require('graphql-compose');

var _mappingConverter = require('./mappingConverter');

var _search = require('./resolvers/search');

var _search2 = _interopRequireDefault(_search);

var _searchConnection = require('./resolvers/searchConnection');

var _searchConnection2 = _interopRequireDefault(_searchConnection);

var _findById = require('./resolvers/findById');

var _findById2 = _interopRequireDefault(_findById);

var _updateById = require('./resolvers/updateById');

var _updateById2 = _interopRequireDefault(_updateById);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function composeWithElastic(opts) {
  if (!opts) {
    throw new Error('Opts is required argument for composeWithElastic()');
  }

  if (!opts.elasticMapping || !opts.elasticMapping.properties) {
    throw new Error('You provide incorrect elasticMapping property. It should be an object `{ properties: {} }`');
  }

  if (!opts.elasticIndex || typeof opts.elasticIndex !== 'string') {
    throw new Error('Third arg for Resolver search() should contain `elasticIndex` string property from your Elastic server.');
  }

  if (!opts.elasticType || typeof opts.elasticType !== 'string') {
    throw new Error('Third arg for Resolver search() should contain `elasticType` string property from your Elastic server.');
  }

  if (typeof opts.graphqlTypeName !== 'string' || !opts.graphqlTypeName) {
    throw new Error('Opts.graphqlTypeName is required property for generated GraphQL Type name in composeWithElastic()');
  }

  if (!opts.prefix) {
    opts.prefix = opts.graphqlTypeName; // eslint-disable-line
  }

  if (opts.pluralFields && !Array.isArray(opts.pluralFields)) {
    throw new Error('Opts.pluralFields should be an Array of strings with field names ' + 'which are plural (you may use dot notation for nested fields).');
  }

  var fieldMap = (0, _mappingConverter.inputPropertiesToGraphQLTypes)(opts.elasticMapping);
  var sourceTC = (0, _mappingConverter.convertToSourceTC)(opts.elasticMapping, opts.graphqlTypeName, opts);

  var searchR = (0, _search2.default)(fieldMap, sourceTC, opts);
  var searchConnectionR = (0, _searchConnection2.default)(searchR, opts);
  var findByIdR = (0, _findById2.default)(fieldMap, sourceTC, opts);
  var updateByIdR = (0, _updateById2.default)(fieldMap, sourceTC, opts);

  sourceTC.addResolver(searchR);
  sourceTC.addResolver(searchConnectionR);
  sourceTC.addResolver(findByIdR);
  sourceTC.addResolver(updateByIdR);

  return sourceTC;
}