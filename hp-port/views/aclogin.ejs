<!DOCTYPE html>
<html>

<head>
    <title><%= title %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/stylesheets/confirm.css">
</head>

<body>
    <div class="container white">
        <div class="info">
            <div class="header">
                <img
                    src="https://media.hpstore.cn/static/version1560379864/frontend/HPOLS/default/zh_Hans_CN/images/logo.svg">
                <p>惠普中国</p>
            </div>
            <div class="line"></div>
            <div class="loginInput">
                <div class="userInput">
                    <label class="title">用户名</label><input class="inputs username" type="text">
                </div>
                <div class="userInput">
                    <label class="title">密码</label><input class="inputs password" type="password">
                </div>
                <a id="confirmUserBtn" class="confirm" href="#">确认登录</a>
                <a id="cancelUserBtn" class="cancel" href="#">取消登录</a>
            </div>
        </div>
    </div>
    <div class="model">
        <div class="modelContent">
            <div class="errorContent">用户名或密码有误</div>
            <a id="errorBtn" class="confirm" href="#">确定</a>
        </div>
    </div>
</body>
<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/socket.io.js"></script>
<script>
    var socket = io();

    // 点击提交按钮
    $('#confirmUserBtn').click(function (e) {
        e.preventDefault(); // prevents page reloading
        if (!$(".username").val() && $(".password").val()) {
            $('.model').show();
            $('.errorContent').html('请输入用户名');
        } else if ($(".username").val() && !$(".password").val()) {
            $('.model').show();
            $('.errorContent').html('请输入密码');
        } else if (!$(".username").val() && !$(".password").val()) {
            $('.model').show();
            $('.errorContent').html('请输入用户名和密码');
        } else {
            socket.emit('message', {
                userName: $(".username").val(),
                password: $(".password").val()
            })
        }
        var loader = setTimeout(function () {
            $('.model').hide();
            clearTimeout(loader);
        }, 2000)
        return false;
    });

    // 点击取消提交按钮
    $('#cancelUserBtn').click(function () {
        socket.emit('leave', {
            pageId: "<%= qruid %>"
        });
        if (WeixinJSBridge) {
            WeixinJSBridge.call('closeWindow');
        } else {
            window.opener = null;
            window.open('', '_self');
            window.close();
        }
    })

    // 点击关闭提示框按钮
    $('#errorBtn').click(function(){
        $('.model').hide();
        $(".username").val('');
        $(".password").val('');
    })

    $(function () {
        //向服务器端发送自定义消息
        socket.on('join', function (data) {
            console.log('join  ' + data.scanState)
        })

        socket.emit('join', {
            pageId: "<%= qruid %>"
        });

        //收到有新的人加入房间的信息
        socket.on('sys', function (data) {
            console.log('sys  ' + data)
        });

        socket.on('logstate', function (data) {
            console.log(data);
            localStorage.setItem("uid", data.uid);
            if (data.state === 1) {
                if (WeixinJSBridge) {
                    WeixinJSBridge.call('closeWindow');
                } else {
                    window.opener = null;
                    window.open('', '_self');
                    window.close();
                }
            } else {
                // 用户名密码不对
                $('.errorContent').html('用户名或密码有误');
                $('.model').show();
            }
        })


        // if (sessionStorage.getItem("wsId")) {
        //     socket.close();
        // } else {
        // socket.emit('scanned', function (msg) {
        //     console.log(msg)
        // });
        // socket.on('scanned', function (msg) {
        //     // sessionStorage.setItem("wsId", msg.wsId);
        //     wsid = msg.wsId
        // });

        // var wsIdSession = setInterval(function () {
        //     if (sessionStorage.getItem("wsId")) {
        //         clearInterval(wsIdSession)
        //         // 验证参数
        //         socket.emit('verfiyUser', {
        //             wsId: sessionStorage.getItem("wsId"),
        //         });

        //         socket.on('verfiyUser', function (msg) {
        //             // console.log(msg.urlState)
        //             // if (!msg.urlState) {
        //             //     socket.close();
        //             //     $('.model').show();
        //             //     $('.errorContent').html('链接失效请刷新二维码');
        //             //     var loader = setTimeout(function () {
        //             //         $('.model').hide();
        //             //         clearTimeout(loader);
        //             //     }, 2000)
        //             //     if (WeixinJSBridge) {
        //             //         WeixinJSBridge.call('closeWindow');
        //             //     } else {
        //             //         window.opener = null;
        //             //         window.open('', '_self');
        //             //         window.close();
        //             //     }
        //             // }
        //         });
        //     }
        // }, 10)
        // socket.on('loginMessage', function (msg) {
        //     if (msg.qrState === 3) {
        //         if (WeixinJSBridge) {
        //             WeixinJSBridge.call('closeWindow');
        //         } else {
        //             window.opener = null;
        //             window.open('', '_self');
        //             window.close();
        //         }
        //     } else if (msg.qrState === 4) {
        //         $('.model').show();
        //     }
        // });
        // }
    });

</script>

</html>